(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{436:function(s,e,a){"use strict";a.r(e);var t=a(2),n=Object(t.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",{attrs:{align:"center"}},[e("img",{attrs:{src:"/img/blog/20220324095540.png"}})]),s._v(" "),e("p",[s._v("在开发测试环境中，我们一般搭建Redis的单实例来应对开发测试需求，但是在生产环境，如果对可用性、可靠性要求较高，则需要引入Redis的集群方案。虽然现在各大云平台有提供缓存服务可以直接使用，但了解一下其背后的实现与原理总还是有些必要（比如面试）， 本文就一起来学习一下Redis的几种集群方案。")]),s._v(" "),e("p",[s._v("Redis支持三种集群方案")]),s._v(" "),e("ul",[e("li",[s._v("主从复制模式")]),s._v(" "),e("li",[s._v("Sentinel（哨兵）模式")]),s._v(" "),e("li",[s._v("Cluster模式")])]),s._v(" "),e("h2",{attrs:{id:"主从复制模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制模式"}},[s._v("#")]),s._v(" 主从复制模式")]),s._v(" "),e("h3",{attrs:{id:"_1-基本原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-基本原理"}},[s._v("#")]),s._v(" 1. 基本原理")]),s._v(" "),e("p",[s._v("主从复制模式中包含一个主数据库实例（master）与一个或多个从数据库实例（slave），如下图")]),s._v(" "),e("p",[e("img",{attrs:{src:"/img/blog/20220324095725.png",alt:"redis-master-slave"}})]),s._v(" "),e("p",[s._v("客户端可对主数据库进行读写操作，对从数据库进行读操作，主数据库写入的数据会实时自动同步给从数据库。")]),s._v(" "),e("p",[s._v("具体工作机制为：")]),s._v(" "),e("ol",[e("li",[s._v("slave启动后，向master发送SYNC命令，master接收到SYNC命令后通过bgsave保存快照（即上文所介绍的RDB持久化），并使用缓冲区记录保存快照这段时间内执行的写命令")]),s._v(" "),e("li",[s._v("master将保存的快照文件发送给slave，并继续记录执行的写命令")]),s._v(" "),e("li",[s._v("slave接收到快照文件后，加载快照文件，载入数据")]),s._v(" "),e("li",[s._v("master快照发送完后开始向slave发送缓冲区的写命令，slave接收命令并执行，完成复制初始化")]),s._v(" "),e("li",[s._v("此后master每次执行一个写命令都会同步发送给slave，保持master与slave之间数据的一致性")])]),s._v(" "),e("h3",{attrs:{id:"_2-部署示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署示例"}},[s._v("#")]),s._v(" 2. 部署示例")]),s._v(" "),e("p",[s._v("本示例基于Redis 5.0.3版。")]),s._v(" "),e("p",[s._v("redis.conf的主要配置")]),s._v(" "),e("div",{staticClass:"language-conf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('###网络相关###\n# bind 127.0.0.1 # 绑定监听的网卡IP，注释掉或配置成0.0.0.0可使任意IP均可访问\nprotected-mode no # 关闭保护模式，使用密码访问\nport 6379  # 设置监听端口，建议生产环境均使用自定义端口\ntimeout 30 # 客户端连接空闲多久后断开连接，单位秒，0表示禁用\n\n###通用配置###\ndaemonize yes # 在后台运行\npidfile /var/run/redis_6379.pid  # pid进程文件名\nlogfile /usr/local/redis/logs/redis.log # 日志文件的位置\n\n###RDB持久化配置###\nsave 900 1 # 900s内至少一次写操作则执行bgsave进行RDB持久化\nsave 300 10\nsave 60 10000 \n# 如果禁用RDB持久化，可在这里添加 save ""\nrdbcompression yes #是否对RDB文件进行压缩，建议设置为no，以（磁盘）空间换（CPU）时间\ndbfilename dump.rdb # RDB文件名称\ndir /usr/local/redis/datas # RDB文件保存路径，AOF文件也保存在这里\n\n###AOF配置###\nappendonly yes # 默认值是no，表示不使用AOF增量持久化的方式，使用RDB全量持久化的方式\nappendfsync everysec # 可选值 always， everysec，no，建议设置为everysec\n\n###设置密码###\nrequirepass 123456 # 设置复杂一点的密码\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("p",[s._v("部署主从复制模式只需稍微调整slave的配置，在redis.conf中添加")]),s._v(" "),e("div",{staticClass:"language-conf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("replicaof 127.0.0.1 6379 # master的ip，port\nmasterauth 123456 # master的密码\nreplica-serve-stale-data no # 如果slave无法与master同步，设置成slave不可读，方便监控脚本发现问题\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("本示例在单台服务器上配置master端口6379，两个slave端口分别为7001,7002，启动master，再启动两个slave")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 master-slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server master.conf")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 master-slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server slave1.conf")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 master-slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server slave2.conf")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("进入master数据库，写入一个数据，再进入一个slave数据库，立即便可访问刚才写入master数据库的数据。如下所示")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 master-slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli ")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" auth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" site blog.jboost.cn\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" get site\n"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blog.jboost.cn"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info replication\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master\nconnected_slaves:2\nslave0:ip"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(",state"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13364738")]),s._v(",lag"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nslave1:ip"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(",state"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13364738")]),s._v(",lag"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 master-slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 7001")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" auth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" get site\n"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blog.jboost.cn"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("执行"),e("code",[s._v("info replication")]),s._v("命令可以查看连接该数据库的其它库的信息，如上可看到有两个slave连接到master")]),s._v(" "),e("h3",{attrs:{id:"_3-主从复制的优缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-主从复制的优缺点"}},[s._v("#")]),s._v(" 3. 主从复制的优缺点")]),s._v(" "),e("p",[s._v("优点：")]),s._v(" "),e("ol",[e("li",[s._v("master能自动将数据同步到slave，可以进行读写分离，分担master的读压力")]),s._v(" "),e("li",[s._v("master、slave之间的同步是以非阻塞的方式进行的，同步期间，客户端仍然可以提交查询或更新请求")])]),s._v(" "),e("p",[s._v("缺点：")]),s._v(" "),e("ol",[e("li",[s._v("不具备自动容错与恢复功能，master或slave的宕机都可能导致客户端请求失败，需要等待机器重启或手动切换客户端IP才能恢复")]),s._v(" "),e("li",[s._v("master宕机，如果宕机前数据没有同步完，则切换IP后会存在数据不一致的问题")]),s._v(" "),e("li",[s._v("难以支持在线扩容，Redis的容量受限于单机配置")])]),s._v(" "),e("h2",{attrs:{id:"sentinel（哨兵）模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sentinel（哨兵）模式"}},[s._v("#")]),s._v(" Sentinel（哨兵）模式")]),s._v(" "),e("h3",{attrs:{id:"_1-基本原理-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-基本原理-2"}},[s._v("#")]),s._v(" 1. 基本原理")]),s._v(" "),e("p",[s._v("哨兵模式基于主从复制模式，只是引入了哨兵来监控与自动处理故障。如图")]),s._v(" "),e("p",[e("img",{attrs:{src:"/img/blog/20220324095738.png",alt:"redis-sentinel"}})]),s._v(" "),e("p",[s._v("哨兵顾名思义，就是来为Redis集群站哨的，一旦发现问题能做出相应的应对处理。其功能包括")]),s._v(" "),e("ol",[e("li",[s._v("监控master、slave是否正常运行")]),s._v(" "),e("li",[s._v("当master出现故障时，能自动将一个slave转换为master（大哥挂了，选一个小弟上位）")]),s._v(" "),e("li",[s._v("多个哨兵可以监控同一个Redis，哨兵之间也会自动监控")])]),s._v(" "),e("p",[s._v("哨兵模式的具体工作机制：")]),s._v(" "),e("p",[s._v("在配置文件中通过 "),e("code",[s._v("sentinel monitor <master-name> <ip> <redis-port> <quorum>")]),s._v(" 来定位master的IP、端口，一个哨兵可以监控多个master数据库，只需要提供多个该配置项即可。哨兵启动后，会与要监控的master建立两条连接：")]),s._v(" "),e("ol",[e("li",[s._v("一条连接用来订阅master的"),e("code",[s._v("_sentinel_:hello")]),s._v("频道与获取其他监控该master的哨兵节点信息")]),s._v(" "),e("li",[s._v("另一条连接定期向master发送INFO等命令获取master本身的信息")])]),s._v(" "),e("p",[s._v("与master建立连接后，哨兵会执行三个操作：")]),s._v(" "),e("ol",[e("li",[s._v("定期（一般10s一次，当master被标记为主观下线时，改为1s一次）向master和slave发送INFO命令")]),s._v(" "),e("li",[s._v("定期向master和slave的"),e("code",[s._v("_sentinel_:hello")]),s._v("频道发送自己的信息")]),s._v(" "),e("li",[s._v("定期（1s一次）向master、slave和其他哨兵发送PING命令")])]),s._v(" "),e("p",[s._v("发送INFO命令可以获取当前数据库的相关信息从而实现新节点的自动发现。所以说哨兵只需要配置master数据库信息就可以自动发现其slave信息。获取到slave信息后，哨兵也会与slave建立两条连接执行监控。通过INFO命令，哨兵可以获取主从数据库的最新信息，并进行相应的操作，比如角色变更等。")]),s._v(" "),e("p",[s._v("接下来哨兵向主从数据库的_sentinel_:hello频道发送信息与同样监控这些数据库的哨兵共享自己的信息，发送内容为哨兵的ip端口、运行id、配置版本、master名字、master的ip端口还有master的配置版本。这些信息有以下用处：")]),s._v(" "),e("ol",[e("li",[s._v("其他哨兵可以通过该信息判断发送者是否是新发现的哨兵，如果是的话会创建一个到该哨兵的连接用于发送PING命令。")]),s._v(" "),e("li",[s._v("其他哨兵通过该信息可以判断master的版本，如果该版本高于直接记录的版本，将会更新")]),s._v(" "),e("li",[s._v("当实现了自动发现slave和其他哨兵节点后，哨兵就可以通过定期发送PING命令定时监控这些数据库和节点有没有停止服务。")])]),s._v(" "),e("p",[s._v("如果被PING的数据库或者节点超时（通过 "),e("code",[s._v("sentinel down-after-milliseconds master-name milliseconds")]),s._v(" 配置）未回复，哨兵认为其主观下线（sdown，s就是Subjectively —— 主观地）。如果下线的是master，哨兵会向其它哨兵发送命令询问它们是否也认为该master主观下线，如果达到一定数目（即配置文件中的quorum）投票，哨兵会认为该master已经客观下线（odown，o就是Objectively —— 客观地），并选举领头的哨兵节点对主从系统发起故障恢复。若没有足够的sentinel进程同意master下线，master的客观下线状态会被移除，若master重新向sentinel进程发送的PING命令返回有效回复，master的主观下线状态就会被移除")]),s._v(" "),e("p",[s._v("哨兵认为master客观下线后，故障恢复的操作需要由选举的领头哨兵来执行，选举采用Raft算法：")]),s._v(" "),e("ol",[e("li",[s._v("发现master下线的哨兵节点（我们称他为A）向每个哨兵发送命令，要求对方选自己为领头哨兵")]),s._v(" "),e("li",[s._v("如果目标哨兵节点没有选过其他人，则会同意选举A为领头哨兵")]),s._v(" "),e("li",[s._v("如果有超过一半的哨兵同意选举A为领头，则A当选")]),s._v(" "),e("li",[s._v("如果有多个哨兵节点同时参选领头，此时有可能存在一轮投票无竞选者胜出，此时每个参选的节点等待一个随机时间后再次发起参选请求，进行下一轮投票竞选，直至选举出领头哨兵")])]),s._v(" "),e("p",[s._v("选出领头哨兵后，领头者开始对系统进行故障恢复，从出现故障的master的从数据库中挑选一个来当选新的master,选择规则如下：")]),s._v(" "),e("ol",[e("li",[s._v("所有在线的slave中选择优先级最高的，优先级可以通过slave-priority配置")]),s._v(" "),e("li",[s._v("如果有多个最高优先级的slave，则选取复制偏移量最大（即复制越完整）的当选")]),s._v(" "),e("li",[s._v("如果以上条件都一样，选取id最小的slave")])]),s._v(" "),e("p",[s._v("挑选出需要继任的slave后，领头哨兵向该数据库发送命令使其升格为master，然后再向其他slave发送命令接受新的master，最后更新数据。将已经停止的旧的master更新为新的master的从数据库，使其恢复服务后以slave的身份继续运行。")]),s._v(" "),e("h3",{attrs:{id:"_2-部署演示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署演示"}},[s._v("#")]),s._v(" 2. 部署演示")]),s._v(" "),e("p",[s._v("本示例基于Redis 5.0.3版。")]),s._v(" "),e("p",[s._v("哨兵模式基于前文的主从复制模式。哨兵的配置文件为sentinel.conf，在文件中添加")]),s._v(" "),e("div",{staticClass:"language-conf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("sentinel monitor mymaster 127.0.0.1 6379 1 # mymaster定义一个master数据库的名称，后面是master的ip， port，1表示至少需要一个Sentinel进程同意才能将master判断为失效，如果不满足这个条件，则自动故障转移（failover）不会执行\nsentinel auth-pass mymaster 123456 # master的密码\n\nsentinel down-after-milliseconds mymaster 5000 # 5s未回复PING，则认为master主观下线，默认为30s\nsentinel parallel-syncs mymaster 2  # 指定在执行故障转移时，最多可以有多少个slave实例在同步新的master实例，在slave实例较多的情况下这个数字越小，同步的时间越长，完成故障转移所需的时间就越长\nsentinel failover-timeout mymaster 300000 # 如果在该时间（ms）内未能完成故障转移操作，则认为故障转移失败，生产环境需要根据数据量设置该值\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("blockquote",[e("p",[s._v("一个哨兵可以监控多个master数据库，只需按上述配置添加多套")])]),s._v(" "),e("p",[s._v("分别以26379,36379,46379端口启动三个sentinel")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 sentinel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server sentinel1.conf --sentinel")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 sentinel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server sentinel2.conf --sentinel")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 sentinel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server sentinel3.conf --sentinel")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("也可以使用"),e("code",[s._v("redis-sentinel sentinel1.conf")]),s._v(" 命令启动。此时集群包含一个master、两个slave、三个sentinel，如图，")]),s._v(" "),e("p",[e("img",{attrs:{src:"/img/blog/20220324095748.png",alt:"redis-cluster-instance"}})]),s._v(" "),e("p",[s._v("我们来模拟master挂掉的场景，执行 "),e("code",[s._v("kill -9 3017")]),s._v(" 将master进程干掉，进入slave中执行 "),e("code",[s._v("info replication")]),s._v("查看，")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 sentinel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 7001")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" auth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" info replication\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:slave\nmaster_host:127.0.0.1\nmaster_port:7002\nmaster_link_status:up\nmaster_last_io_seconds_ago:1\nmaster_sync_in_progress:0\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 省略")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 sentinel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 7002")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" auth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:700"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" info replication\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master\nconnected_slaves:1\nslave0:ip"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(",state"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13642721")]),s._v(",lag"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 省略")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("可以看到slave 7002已经成功上位晋升为master（role：master），接收一个slave 7001的连接。此时查看slave2.conf配置文件，发现"),e("code",[s._v("replicaof")]),s._v("的配置已经被移除了，slave1.conf的配置文件里"),e("code",[s._v("replicaof 127.0.0.1 6379")]),s._v(" 被改为 "),e("code",[s._v("replicaof 127.0.0.1 7002")]),s._v("。重新启动master，也可以看到master.conf配置文件中添加了"),e("code",[s._v("replicaof 127.0.0.1 7002")]),s._v("的配置项，可见大哥（master）下位后，再出来混就只能当当小弟（slave）了，三十年河东三十年河西。")]),s._v(" "),e("h3",{attrs:{id:"_3-哨兵模式的优缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-哨兵模式的优缺点"}},[s._v("#")]),s._v(" 3. 哨兵模式的优缺点")]),s._v(" "),e("p",[s._v("优点：")]),s._v(" "),e("ol",[e("li",[s._v("哨兵模式基于主从复制模式，所以主从复制模式有的优点，哨兵模式也有")]),s._v(" "),e("li",[s._v("哨兵模式下，master挂掉可以自动进行切换，系统可用性更高")])]),s._v(" "),e("p",[s._v("缺点：")]),s._v(" "),e("ol",[e("li",[s._v("同样也继承了主从模式难以在线扩容的缺点，Redis的容量受限于单机配置")]),s._v(" "),e("li",[s._v("需要额外的资源来启动sentinel进程，实现相对复杂一点，同时slave节点作为备份节点不提供服务")])]),s._v(" "),e("h2",{attrs:{id:"cluster模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cluster模式"}},[s._v("#")]),s._v(" Cluster模式")]),s._v(" "),e("h3",{attrs:{id:"_1-基本原理-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-基本原理-3"}},[s._v("#")]),s._v(" 1. 基本原理")]),s._v(" "),e("p",[s._v("哨兵模式解决了主从复制不能自动故障转移，达不到高可用的问题，但还是存在难以在线扩容，Redis容量受限于单机配置的问题。Cluster模式实现了Redis的分布式存储，即每台节点存储不同的内容，来解决在线扩容的问题。如图")]),s._v(" "),e("p",[e("img",{attrs:{src:"/img/blog/20220324095754.png",alt:"redis-cluster"}})]),s._v(" "),e("p",[s._v("Cluster采用无中心结构,它的特点如下：")]),s._v(" "),e("ol",[e("li",[s._v("所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽")]),s._v(" "),e("li",[s._v("节点的fail是通过集群中超过半数的节点检测失效时才生效")]),s._v(" "),e("li",[s._v("客户端与redis节点直连,不需要中间代理层.客户端不需要连接集群所有节点,连接集群中任何一个可用节点即可")])]),s._v(" "),e("p",[s._v("Cluster模式的具体工作机制：")]),s._v(" "),e("ol",[e("li",[s._v("在Redis的每个节点上，都有一个插槽（slot），取值范围为0-16383")]),s._v(" "),e("li",[s._v("当我们存取key的时候，Redis会根据CRC16的算法得出一个结果，然后把结果对16384求余数，这样每个key都会对应一个编号在0-16383之间的哈希槽，通过这个值，去找到对应的插槽所对应的节点，然后直接自动跳转到这个对应的节点上进行存取操作")]),s._v(" "),e("li",[s._v("为了保证高可用，Cluster模式也引入主从复制模式，一个主节点对应一个或者多个从节点，当主节点宕机的时候，就会启用从节点")]),s._v(" "),e("li",[s._v("当其它主节点ping一个主节点A时，如果半数以上的主节点与A通信超时，那么认为主节点A宕机了。如果主节点A和它的从节点都宕机了，那么该集群就无法再提供服务了")])]),s._v(" "),e("p",[s._v("Cluster模式集群节点最小配置6个节点(3主3从，因为需要半数以上)，其中主节点提供读写操作，从节点作为备用节点，不提供请求，只作为故障转移使用。")]),s._v(" "),e("h3",{attrs:{id:"_2-部署演示-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署演示-2"}},[s._v("#")]),s._v(" 2. 部署演示")]),s._v(" "),e("p",[s._v("本示例基于Redis 5.0.3版。")]),s._v(" "),e("p",[s._v("Cluster模式的部署比较简单，首先在redis.conf中")]),s._v(" "),e("div",{staticClass:"language-conf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("port 7100 # 本示例6个节点端口分别为7100,7200,7300,7400,7500,7600 \ndaemonize yes # r后台运行 \npidfile /var/run/redis_7100.pid # pidfile文件对应7100,7200,7300,7400,7500,7600 \ncluster-enabled yes # 开启集群模式 \nmasterauth passw0rd # 如果设置了密码，需要指定master密码\ncluster-config-file nodes_7100.conf # 集群的配置文件，同样对应7100,7200等六个节点\ncluster-node-timeout 15000 # 请求超时 默认15秒，可自行设置 \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("分别以端口7100,7200,7300,7400,7500,7600 启动六个实例(如果是每个服务器一个实例则配置可一样)")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 cluster"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server redis_7100.conf")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 cluster"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server redis_7200.conf")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("然后通过命令将这个6个实例组成一个3主节点3从节点的集群，")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" create --cluster-replicas "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7100 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7200 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7300 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7400 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7500 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7600 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" passw0rd\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("执行结果如图")]),s._v(" "),e("p",[e("img",{attrs:{src:"/img/blog/20220324095804.png",alt:"redis-cluster-deploy"}})]),s._v(" "),e("p",[s._v("可以看到 7100， 7200， 7300 作为3个主节点，分配的slot分别为 0-5460， 5461-10922， 10923-16383， 7600作为7100的slave， 7500作为7300的slave，7400作为7200的slave。")]),s._v(" "),e("p",[s._v("我们连接7100设置一个值")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev-server-1 cluster"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 7100 -c -a passw0rd")]),s._v("\nWarning: Using a password with "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-a'")]),s._v(" or "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-u'")]),s._v(" option on the "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" line interface may not be safe.\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:710"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" site blog.jboost.cn\n-"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9421")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7200\nOK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:720"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(" get site\n"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blog.jboost.cn"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:720"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("注意添加 -c 参数表示以集群模式，否则报 "),e("code",[s._v("(error) MOVED 9421 127.0.0.1:7200")]),s._v(" 错误， 以 -a 参数指定密码，否则报"),e("code",[s._v("(error) NOAUTH Authentication required")]),s._v("错误。")]),s._v(" "),e("p",[s._v("从上面命令看到key为site算出的slot为9421，落在7200节点上，所以有"),e("code",[s._v("Redirected to slot [9421] located at 127.0.0.1:7200")]),s._v("，集群会自动进行跳转。因此客户端可以连接任何一个节点来进行数据的存取。")]),s._v(" "),e("p",[s._v("通过"),e("code",[s._v("cluster nodes")]),s._v("可查看集群的节点信息")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:720"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(" cluster nodes\neb28aaf090ed1b6b05033335e3d90a202b422d6c "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7500@17500 slave c1047de2a1b5d5fa4666d554376ca8960895a955 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165266071")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" connected\n4cc0463878ae00e5dcf0b36c4345182e021932bc "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7400@17400 slave 5544aa5ff20f14c4c3665476de6e537d76316b4a "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165267074")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" connected\ndbbb6420d64db22f35a9b6fa460b0878c172a2fb "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7100@17100 master - "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165266000")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" connected "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-5460\nd4b434f5829e73e7e779147e905eea6247ffa5a2 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7600@17600 slave dbbb6420d64db22f35a9b6fa460b0878c172a2fb "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165265000")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" connected\n5544aa5ff20f14c4c3665476de6e537d76316b4a "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7200@17200 myself,master - "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165267000")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" connected "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("-10922\nc1047de2a1b5d5fa4666d554376ca8960895a955 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:7300@17300 master - "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1584165268076")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" connected "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v("-16383\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("我们将7200通过 "),e("code",[s._v("kill -9 pid")]),s._v("杀死进程来验证集群的高可用，重新进入集群执行"),e("code",[s._v("cluster nodes")]),s._v("可以看到7200 fail了，但是7400成了master，重新启动7200，可以看到此时7200已经变成了slave。")]),s._v(" "),e("h3",{attrs:{id:"_3-cluster模式的优缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-cluster模式的优缺点"}},[s._v("#")]),s._v(" 3. Cluster模式的优缺点")]),s._v(" "),e("p",[s._v("优点：")]),s._v(" "),e("ol",[e("li",[s._v("无中心架构，数据按照slot分布在多个节点。")]),s._v(" "),e("li",[s._v("集群中的每个节点都是平等的关系，每个节点都保存各自的数据和整个集群的状态。每个节点都和其他所有节点连接，而且这些连接保持活跃，这样就保证了我们只需要连接集群中的任意一个节点，就可以获取到其他节点的数据。")]),s._v(" "),e("li",[s._v("可线性扩展到1000多个节点，节点可动态添加或删除")]),s._v(" "),e("li",[s._v("能够实现自动故障转移，节点之间通过gossip协议交换状态信息，用投票机制完成slave到master的角色转换")])]),s._v(" "),e("p",[s._v("缺点：")]),s._v(" "),e("ol",[e("li",[s._v("客户端实现复杂，驱动要求实现Smart Client，缓存slots mapping信息并及时更新，提高了开发难度。目前仅JedisCluster相对成熟，异常处理还不完善，比如常见的“max redirect exception”")]),s._v(" "),e("li",[s._v("节点会因为某些原因发生阻塞（阻塞时间大于 cluster-node-timeout）被判断下线，这种failover是没有必要的")]),s._v(" "),e("li",[s._v("数据通过异步复制，不保证数据的强一致性")]),s._v(" "),e("li",[s._v("slave充当“冷备”，不能缓解读压力")]),s._v(" "),e("li",[s._v("批量操作限制，目前只支持具有相同slot值的key执行批量操作，对mset、mget、sunion等操作支持不友好")]),s._v(" "),e("li",[s._v("key事务操作支持有线，只支持多key在同一节点的事务操作，多key分布不同节点时无法使用事务功能")]),s._v(" "),e("li",[s._v("不支持多数据库空间，单机redis可以支持16个db，集群模式下只能使用一个，即db 0")])]),s._v(" "),e("p",[s._v("Redis Cluster模式不建议使用pipeline和multi-keys操作，减少max redirect产生的场景。")]),s._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("p",[s._v("本文介绍了Redis集群方案的三种模式，其中主从复制模式能实现读写分离，但是不能自动故障转移；哨兵模式基于主从复制模式，能实现自动故障转移，达到高可用，但与主从复制模式一样，不能在线扩容，容量受限于单机的配置；Cluster模式通过无中心化架构，实现分布式存储，可进行线性扩展，也能高可用，但对于像批量操作、事务操作等的支持性不够好。三种模式各有优缺点，可根据实际场景进行选择。")]),s._v(" "),e("p",[s._v("参考：")]),s._v(" "),e("ol",[e("li",[s._v("https://blog.csdn.net/q649381130/article/details/79931791")]),s._v(" "),e("li",[s._v("https://www.cnblogs.com/51life/p/10233340.html")]),s._v(" "),e("li",[s._v("https://www.cnblogs.com/chensuqian/p/10538365.html")]),s._v(" "),e("li",[s._v("https://stor.51cto.com/art/201910/604653.htm")])]),s._v(" "),e("p",[s._v("原文地址："),e("a",{attrs:{href:"https://www.cnblogs.com/spec-dog/p/12501895.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("一文掌握Redis的三种集群方案"),e("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);